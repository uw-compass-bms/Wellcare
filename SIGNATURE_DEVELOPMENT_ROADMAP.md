# 电子签名功能开发路线图

## 项目现状分析

### 已完成功能
1. **基础架构**
   - ✅ PDF 查看器 (react-pdf)
   - ✅ 字段拖拽系统 (react-rnd)
   - ✅ 响应式坐标系统（百分比）
   - ✅ API CRUD 操作
   - ✅ 撤销/重做功能
   - ✅ 移动端适配
   - ✅ 虚拟化性能优化

2. **数据库设计**
   - ✅ 签名任务表 (signature_tasks)
   - ✅ 文件表 (signature_files)
   - ✅ 收件人表 (signature_recipients)
   - ✅ 位置表 (signature_positions)

### 核心问题
1. **字段类型未实现** - 数据库缺少 field_type 字段
2. **无交互功能** - Text、Date 等字段无法输入
3. **无签名画板** - Signature 字段无法绘制签名
4. **无验证机制** - 缺少必填项和格式验证
5. **无属性面板** - 无法配置字段属性

## 开发路线图

### 第一阶段：数据库和API完善（2天）

#### 1.1 数据库迁移
```sql
-- 添加字段类型和元数据
ALTER TABLE signature_positions 
ADD COLUMN field_type TEXT CHECK (field_type IN ('signature', 'text', 'date', 'name', 'email', 'number', 'checkbox')) DEFAULT 'signature',
ADD COLUMN field_meta JSONB DEFAULT '{}',
ADD COLUMN is_required BOOLEAN DEFAULT true,
ADD COLUMN default_value TEXT;

-- 创建索引
CREATE INDEX idx_positions_field_type ON signature_positions(field_type);
```

**验证点**：
- [ ] 运行迁移脚本
- [ ] 验证新字段创建成功
- [ ] 测试数据库连接

#### 1.2 API 端点更新
需要更新的文件：
- `/api/signature/positions/route.ts` - 添加 field_type 处理
- `/api/signature/positions/[id]/route.ts` - 更新字段逻辑

**验证点**：
- [ ] POST 请求包含 field_type
- [ ] GET 请求返回 field_type
- [ ] PUT 请求可更新 field_meta

### 第二阶段：字段属性面板（2天）

#### 2.1 创建属性面板组件
```typescript
// components/FieldPropertiesPanel.tsx
- 字段类型选择器
- 必填/选填切换
- 占位符文本输入
- 字段特定配置（如日期格式、文本长度限制）
```

#### 2.2 集成到主画布
- 点击字段显示属性面板
- 实时更新字段属性
- 自动保存到数据库

**验证点**：
- [ ] 属性面板可以打开/关闭
- [ ] 修改属性后自动保存
- [ ] 属性变化实时反映在字段上

### 第三阶段：签名画板实现（3天）

#### 3.1 签名组件开发
```typescript
// components/SignaturePad.tsx
- 使用 react-signature-canvas
- 支持画笔颜色选择
- 清除和撤销功能
- 保存为 base64 图片
```

#### 3.2 签名弹窗集成
- 点击签名字段弹出画板
- 签名预览
- 确认/取消按钮

**验证点**：
- [ ] 可以绘制签名
- [ ] 签名可以清除
- [ ] 签名保存为图片数据

### 第四阶段：文本输入实现（2天）

#### 4.1 文本输入组件
```typescript
// components/TextInput.tsx
- 支持单行/多行文本
- 字符长度限制
- 实时验证
```

#### 4.2 不同文本类型处理
- Name：姓名格式验证
- Email：邮箱格式验证
- Number：数字格式验证
- Text：通用文本输入

**验证点**：
- [ ] 点击文本字段可输入
- [ ] 输入验证工作正常
- [ ] 数据保存到数据库

### 第五阶段：日期选择器（2天）

#### 5.1 日期组件开发
```typescript
// components/DatePicker.tsx
- 使用成熟的日期选择库
- 支持多种日期格式
- 日期范围限制
```

#### 5.2 日期格式配置
- 在属性面板中配置日期格式
- 支持常见格式：MM/DD/YYYY, DD/MM/YYYY, YYYY-MM-DD

**验证点**：
- [ ] 日期选择器正常显示
- [ ] 选择的日期格式正确
- [ ] 日期保存和显示一致

### 第六阶段：复选框实现（1天）

#### 6.1 复选框组件
- 点击切换选中状态
- 自定义样式
- 支持默认值

**验证点**：
- [ ] 复选框可以点击
- [ ] 状态正确保存
- [ ] UI 反馈清晰

### 第七阶段：收件人签名页面（3天）

#### 7.1 公开签名页面
- Token 验证机制
- 只显示当前收件人的字段
- 字段高亮和引导

#### 7.2 字段填写功能
- 根据字段类型显示对应输入组件
- 必填项验证
- 进度指示器

**验证点**：
- [ ] 收件人可以访问签名页面
- [ ] 只能看到自己的字段
- [ ] 所有字段类型都可交互

### 第八阶段：签名完成处理（2天）

#### 8.1 PDF 生成
- 将所有字段数据嵌入 PDF
- 使用 pdf-lib 处理
- 生成最终文件

#### 8.2 完成通知
- 发送邮件通知
- 更新任务状态
- 提供下载链接

**验证点**：
- [ ] PDF 正确生成
- [ ] 签名和文本正确嵌入
- [ ] 可以下载最终文件

### 第九阶段：高级功能（可选）

#### 9.1 模板系统
- 保存常用字段布局
- 快速应用模板

#### 9.2 批量操作
- 批量添加字段
- 批量设置属性

#### 9.3 高级验证
- 自定义正则表达式
- 条件逻辑（如果A则B必填）

## 技术栈建议

### 核心依赖
```json
{
  "react-signature-canvas": "^1.0.6",  // 签名画板
  "react-datepicker": "^4.21.0",       // 日期选择
  "react-hook-form": "^7.48.0",        // 表单验证
  "pdf-lib": "^1.17.1",                // PDF 处理
  "zod": "^3.22.4"                     // 数据验证
}
```

## 开发原则

1. **原子化开发**：每个功能独立完成，确保可测试
2. **数据优先**：先确保数据流通，再优化 UI
3. **渐进增强**：基础功能先行，高级功能后续
4. **持续验证**：每步都有明确的验证点
5. **用户体验**：保持简洁直观的交互

## 时间估算

- 总计：20个工作日
- 核心功能（阶段1-6）：10天
- 完整流程（阶段7-8）：5天
- 高级功能（阶段9）：5天

## 下一步行动

1. **立即执行数据库迁移**（第一阶段）
2. **更新 API 端点支持字段类型**
3. **创建基础 UI 组件**
4. **实现签名画板**（最重要的功能）

## 参考实现

- **Documenso**：简洁的 UI 设计，良好的类型系统
- **OpenSign**：丰富的字段类型，完善的验证机制

通过遵循这个路线图，您将拥有一个功能完整、用户友好的电子签名系统。