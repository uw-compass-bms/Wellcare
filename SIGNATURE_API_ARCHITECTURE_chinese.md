# 电子签字系统API架构文档

## 📋 API概览

### 系统架构
本文档详细描述了电子签字系统的完整API架构，围绕**公开页面 + Token访问**模式设计，具备**一键签字**功能。系统支持多文件、多收件人签字工作流，配备自动化状态追踪功能。

### 核心设计原则
- **简化认证**：通过唯一token可访问公开签字页面
- **RESTful设计**：标准HTTP方法和响应代码
- **无状态操作**：每个请求包含所有必要信息
- **实时更新**：所有实体间自动状态同步
- **移动优先**：专为移动设备签字体验优化

---

## 🔐 认证与授权

### 认证策略
系统实现**双重认证模式**：

1. **认证路由** (`/api/signature/*`)
   - 使用Clerk认证系统，面向任务创建者
   - 需要在Authorization头中提供有效JWT token
   - 对用户签字任务具有完整CRUD访问权限

2. **公开路由** (`/api/sign/*`)
   - 基于Token访问，面向收件人
   - 无需用户认证
   - 仅限于签字相关操作

### 授权级别
- **任务创建者**：对其签字任务及相关数据具有完全访问权限
- **收件人**：对其分配的签字位置具有只读访问权限
- **匿名用户**：无法访问认证端点

---

## 🏗️ API结构

### 基础URL结构
```
/api/signature/*    - 认证端点（任务创建者）
/api/sign/*         - 公开端点（收件人）
/api/auth/*         - 认证工具
```

### 响应格式标准
所有API响应遵循一致格式：
- **成功响应**：包含数据对象和成功指示器
- **错误响应**：包含错误代码、消息和可选详细信息
- **分页处理**：对大数据集使用基于游标的分页
- **时间戳**：所有时间戳采用ISO 8601格式，包含时区信息

---

## 📊 数据库驱动端点

### 任务管理端点

#### `GET /api/signature/tasks`
**功能**：获取认证用户的所有签字任务
**认证**：必需（Clerk JWT）
**数据库查询**：查询`signature_tasks`表中`user_id`匹配认证用户的记录
**响应数据**：
- 包含基本信息的任务列表（id、title、status、created_at）
- 聚合统计（总收件人数、已签字数、文件数）
- 状态指示器和完成百分比
- 最近活动时间戳

**过滤选项**：
- 基于状态过滤（draft、in_progress、completed、cancelled）
- 日期范围过滤（created_at、updated_at）
- 按任务标题或描述搜索
- 按创建日期、状态或完成情况排序

#### `POST /api/signature/tasks`
**功能**：创建草稿状态的新签字任务
**认证**：必需（Clerk JWT）
**数据库操作**：向`signature_tasks`表插入记录
**初始状态**：
- 状态设置为'draft'
- 用户ID来自认证会话
- 创建时间戳自动生成
- 初始无文件或收件人

**验证规则**：
- 标题必需（1-200字符）
- 描述可选（最多1000字符）
- 用户必须已认证
- 应用频率限制（每小时最多10个任务）

#### `GET /api/signature/tasks/[id]`
**功能**：获取完整任务详情，包括文件、收件人和位置信息
**认证**：必需（Clerk JWT）
**数据库查询**：跨所有签字表的多表连接查询
**响应包含**：
- 任务基本信息
- 关联文件列表及元数据
- 收件人列表及状态和进度
- 每个收件人-文件组合的签字位置
- 状态变更审计跟踪

**访问控制**：用户只能访问自己的任务

#### `PUT /api/signature/tasks/[id]`
**功能**：更新任务信息（标题、描述、状态）
**认证**：必需（Clerk JWT）
**数据库操作**：更新`signature_tasks`记录
**自动触发器**：刷新updated_at时间戳
**状态限制**：
- 可自由修改草稿任务
- 进行中任务的修改受限
- 无法修改已完成任务

#### `DELETE /api/signature/tasks/[id]`
**功能**：删除任务及所有关联数据
**认证**：必需（Clerk JWT）
**数据库操作**：从`signature_tasks`开始级联删除
**文件清理**：从Supabase Storage删除关联文件
**限制**：无法删除包含已签字文档的任务

#### `POST /api/signature/tasks/[id]/send`
**功能**：向所有收件人发送邮件邀请并将任务状态改为进行中
**认证**：必需（Clerk JWT）
**数据库更新**：
- 更新任务状态为'in_progress'
- 设置sent_at时间戳
- 如需要则更新收件人tokens
**邮件操作**：为所有收件人排队发送邀请邮件
**验证**：确保所有收件人都有有效邮箱地址和签字位置

---

### 文件管理端点

#### `POST /api/signature/files/upload`
**功能**：上传PDF文件到签字任务
**认证**：必需（Clerk JWT）
**文件存储**：Supabase Storage bucket `signature-files`
**数据库操作**：向`signature_files`表插入记录
**文件处理**：
- PDF验证和页数提取
- 文件大小验证（可配置限制）
- 任务内自动文件排序
- 存储位置URL生成

**存储路径**：`signature-files/{task_id}/{file_id}_original.pdf`
**支持格式**：仅PDF
**大小限制**：根据部署配置
**元数据提取**：页数、文件大小、原始文件名

#### `GET /api/signature/files/[id]`
**功能**：获取文件元数据和下载信息
**认证**：必需（Clerk JWT）
**数据库查询**：查询`signature_files`并验证任务所有权
**响应数据**：
- 文件元数据（名称、大小、页数、上传日期）
- 原始和最终版本的下载URL
- 状态信息
- 关联任务信息

#### `GET /api/signature/files/[id]/download`
**功能**：生成用于文件访问的签名下载URL
**认证**：必需（Clerk JWT）
**文件访问**：从Supabase Storage生成临时签名URL
**URL过期**：可配置过期时间
**访问控制**：验证用户拥有关联任务

#### `DELETE /api/signature/files/[id]`
**功能**：从任务中删除文件并清理存储
**认证**：必需（Clerk JWT）
**数据库操作**：从`signature_files`表删除记录
**存储清理**：从Supabase Storage删除文件
**级联效应**：删除关联的签字位置
**限制**：无法删除已完成任务的文件

---

### 收件人管理端点

#### `GET /api/signature/tasks/[id]/recipients`
**功能**：获取特定任务的所有收件人
**认证**：必需（Clerk JWT）
**数据库查询**：查询`signature_recipients`并联合位置统计
**响应数据**：
- 收件人基本信息（姓名、邮箱、状态）
- Token过期状态
- 签字进度指示器
- 活动时间戳（viewed_at、signed_at）

#### `POST /api/signature/tasks/[id]/recipients`
**功能**：向签字任务添加新收件人
**认证**：必需（Clerk JWT）
**数据库操作**：向`signature_recipients`表插入记录
**Token生成**：自动创建具有过期时间的唯一token
**验证规则**：
- 邮箱格式验证
- 任务内邮箱去重
- 姓名要求（1-100字符）
- 每任务最大收件人数限制

**Token属性**：
- 系统内唯一
- 创建后7天过期
- Base64编码，URL安全
- 包含时间戳用于追踪

#### `PUT /api/signature/recipients/[id]`
**功能**：更新收件人信息（姓名、邮箱、重新生成token）
**认证**：必需（Clerk JWT）
**数据库操作**：更新`signature_recipients`记录
**Token重新生成**：如需要可创建新token
**邮箱验证**：确保邮箱格式和唯一性
**状态保持**：如适用则维护签字进度

#### `DELETE /api/signature/recipients/[id]`
**功能**：从任务中删除收件人
**认证**：必需（Clerk JWT）
**数据库操作**：从`signature_recipients`表删除记录
**级联效应**：删除关联的签字位置
**限制**：无法删除已经签字的收件人

---

### 签字位置管理端点

#### `GET /api/signature/recipients/[id]/positions`
**功能**：获取特定收件人的所有签字位置
**认证**：必需（Clerk JWT）
**数据库查询**：查询`signature_positions`并联合文件信息
**响应数据**：
- 位置坐标（百分比和像素值）
- 关联文件和页面信息
- 签字状态和内容
- 占位符文本配置

#### `POST /api/signature/recipients/[id]/positions`
**功能**：为收件人创建新签字位置
**认证**：必需（Clerk JWT）
**数据库操作**：向`signature_positions`表插入记录
**坐标处理**：自动从百分比转换为像素值
**验证规则**：
- 坐标边界验证（0-100%）
- 页码与文件页数验证
- 重复位置防护
- 最小尺寸要求

**坐标系统**：支持前端百分比和后端像素双重坐标系统

#### `PUT /api/signature/positions/[id]`
**功能**：更新签字位置坐标或属性
**认证**：必需（Clerk JWT）
**数据库操作**：更新`signature_positions`记录
**坐标重新计算**：自动更新像素坐标
**限制**：无法修改已签字的位置

#### `DELETE /api/signature/positions/[id]`
**功能**：删除签字位置
**认证**：必需（Clerk JWT）
**数据库操作**：从`signature_positions`表删除记录
**限制**：无法删除已签字的位置

---

## 🌐 公开签字API

### 基于Token的访问系统

#### `GET /api/sign/verify?token=xxx`
**功能**：验证收件人token并获取个性化签字界面数据
**认证**：基于Token（无需用户认证）
**数据库查询**：使用token验证的多表连接查询
**响应数据**：
- 收件人身份信息
- 任务详情（标题、描述）
- 仅包含收件人签字位置的个性化文件列表
- Token过期状态
- 收件人签字进度

**Token验证流程**：
- 验证token存在且未过期
- 检查收件人状态（仍可签字）
- 获取关联任务和文件信息
- 过滤位置，仅显示收件人分配的位置

**个性化功能**：
- 仅显示收件人自己的签字位置
- 隐藏其他收件人的位置和信息
- 显示带有收件人姓名的占位符文本
- 仅显示收件人位置的完成状态

#### `POST /api/sign/execute`
**功能**：执行一键签字操作
**认证**：基于Token
**数据库操作**：
- 更新`signature_positions`状态为'signed'
- 使用自动生成格式设置signature_content
- 更新位置signed_at时间戳
- 触发收件人和任务状态更新

**自动生成签字格式**：【{收件人姓名}】signed at【{时间戳}】

**自动状态更新**：
- 如所有收件人位置已签字：更新收件人状态为'signed'
- 如所有收件人已签字：更新任务状态为'completed'
- 触发完成时间戳和通知

**PDF处理**：排队生成嵌入签字的最终PDF

#### `GET /api/sign/status?token=xxx`
**功能**：检查收件人签字进度
**认证**：基于Token
**数据库查询**：聚合收件人位置状态
**响应数据**：
- 收件人签字状态
- 已完成vs总位置数统计
- 整体任务完成状态
- 最后活动时间戳

**进度指示器**：
- 单个位置完成状态
- 收件人级别完成百分比
- 任务级别完成状态
- 基于时间的活动追踪

---

## 📧 邮件集成API

### 邮件服务管理

#### `POST /api/signature/email/invite`
**功能**：向收件人发送签字邀请邮件
**认证**：必需（Clerk JWT）
**邮件服务**：Resend集成
**数据库更新**：记录邮件发送状态和时间戳
**邮件内容**：
- 带收件人姓名的个性化问候
- 任务描述和说明
- 带嵌入token的唯一签字链接
- 过期日期信息
- 发送者联系信息

**邮件模板功能**：
- 响应式HTML设计
- 移动端优化布局
- 清晰的行动召唤按钮
- 专业签字样式
- 可定制品牌元素

#### `POST /api/signature/email/confirmation`
**功能**：发送完成确认邮件
**认证**：必需（Clerk JWT）
**触发条件**：任务完成或收件人完成
**收件人**：任务创建者和所有参与者
**内容变化**：
- 创建者通知：完整任务摘要
- 收件人确认：个人完成确认
- 最终文档附件选项

### 邮件追踪和管理

#### `GET /api/signature/email/status/[taskId]`
**功能**：检查任务的邮件投递状态
**认证**：必需（Clerk JWT）
**响应数据**：
- 每个收件人的邮件投递状态
- 退回和失败通知
- 打开和点击追踪（如启用）
- 重发历史和时间戳

#### `POST /api/signature/email/resend`
**功能**：向特定收件人重新发送邀请邮件
**认证**：必需（Clerk JWT）
**目标选择**：特定收件人或所有待处理收件人
**频率限制**：防止垃圾邮件的重发限制
**Token刷新**：重发时可选择生成新token

---

## 📄 PDF处理API

### PDF生成和操作

#### `POST /api/signature/pdf/generate-final`
**功能**：生成嵌入签字的最终PDF
**认证**：必需（Clerk JWT）
**处理流程**：
- 从存储中获取原始PDF
- 在指定位置应用所有签字覆盖
- 生成嵌入签字的最终PDF
- 在指定存储位置保存最终PDF
- 用最终文件URL更新数据库

**签字渲染**：
- 将百分比坐标转换为精确像素位置
- 应用一致的签字样式
- 嵌入带时间戳的签字内容
- 保持PDF质量和格式

#### `GET /api/signature/pdf/preview/[fileId]`
**功能**：生成显示签字位置的预览PDF
**认证**：必需（Clerk JWT）
**预览功能**：
- 高亮显示签字位置覆盖
- 显示每个位置的占位符文本
- 显示收件人分配
- 保持原始PDF格式

**预览选项**：
- 显示所有位置或特定收件人位置
- 不同收件人使用不同高亮颜色
- 位置编号和标签
- 导出预览为单独PDF

### PDF分析和验证

#### `POST /api/signature/pdf/analyze`
**功能**：分析上传的PDF以推荐签字位置
**认证**：必需（Clerk JWT）
**分析功能**：
- 检测文本字段和表单元素
- 识别签字线模式
- 建议最佳位置放置
- 提取元数据和页面结构

**AI驱动建议**：
- 签字位置的模式识别
- 定位的页面内容分析
- 最佳尺寸建议
- 与现有位置的冲突检测

---

## 🔄 状态管理API

### 实时状态追踪

#### `GET /api/signature/status/[taskId]`
**功能**：获取全面的任务状态信息
**认证**：必需（Clerk JWT）
**数据库查询**：跨所有相关表的聚合状态
**响应数据**：
- 任务级别状态和进展
- 收件人级别完成状态
- 文件级别处理状态
- 位置级别签字状态
- 活动时间线和审计跟踪

**状态指示器**：
- 总体完成百分比
- 个人收件人进度
- 文件处理状态
- 邮件投递状态
- 错误条件和警报

#### `GET /api/signature/status/recipient/[recipientId]`
**功能**：获取特定收件人的详细状态
**认证**：必需（Clerk JWT）
**响应数据**：
- 收件人签字进度
- Token过期状态
- 访问活动日志
- 位置特定状态
- 邮件交互历史

### 状态更新Webhooks

#### `POST /api/signature/webhooks/status-update`
**功能**：接收外部服务的状态更新通知
**认证**：Webhook签名验证
**支持事件**：
- 邮件投递确认
- PDF处理完成
- 文件上传完成
- 系统健康警报

**事件处理**：
- 验证webhook签名
- 更新相关数据库记录
- 触发下游通知
- 记录审计跟踪事件

---

## 🛠️ 实用工具和辅助API

### 系统健康和监控

#### `GET /api/signature/health`
**功能**：系统健康检查和监控
**认证**：不需要
**响应数据**：
- 数据库连接状态
- 存储服务可用性
- 邮件服务连接性
- PDF处理服务状态
- 系统性能指标

#### `GET /api/signature/metrics`
**功能**：获取系统使用指标
**认证**：必需（Clerk JWT）
**包含指标**：
- 用户特定任务统计
- 签字完成率
- 文件处理时间
- 邮件投递成功率
- 错误频率和模式

### 配置和设置

#### `GET /api/signature/config`
**功能**：获取系统配置设置
**认证**：必需（Clerk JWT）
**配置数据**：
- 文件大小限制
- Token过期设置
- 邮件模板选项
- PDF处理参数
- 功能标志和能力

#### `PUT /api/signature/config`
**功能**：更新系统配置（仅管理员）
**认证**：必需（管理员JWT）
**可配置设置**：
- 文件上传限制
- Token过期持续时间
- 邮件模板自定义
- PDF处理选项
- 安全参数

---

## 🔍 搜索和发现API

### 高级搜索功能

#### `GET /api/signature/search?q={query}`
**功能**：搜索用户的签字任务和相关数据
**认证**：必需（Clerk JWT）
**搜索范围**：
- 任务标题和描述
- 收件人姓名和邮箱地址
- 文件名和内容元数据
- 签字位置标签
- 状态和日期范围

**搜索功能**：
- 全文搜索功能
- 带过滤器的分面搜索
- 自动完成建议
- 搜索历史和保存的搜索
- 高级查询操作符

#### `GET /api/signature/recent`
**功能**：获取最近访问或修改的任务
**认证**：必需（Clerk JWT）
**响应数据**：
- 最近创建的任务
- 最近修改的任务
- 最近签字活动
- 最近访问的文件
- 基于活动的推荐

---

## 🔐 安全和合规API

### 访问控制和审计

#### `GET /api/signature/audit/[taskId]`
**功能**：获取特定任务的审计跟踪
**认证**：必需（Clerk JWT）
**审计信息**：
- 用户访问历史
- 状态变更时间线
- 文件修改历史
- 邮件发送历史
- 签字完成事件

**审计功能**：
- 不可变审计日志
- IP地址追踪
- 用户代理信息
- 时间戳精度
- 事件分类

#### `POST /api/signature/security/validate-token`
**功能**：验证token安全性并生成安全报告
**认证**：基于Token
**安全检查**：
- Token过期验证
- 使用频率分析
- 可疑活动检测
- IP地址验证
- 设备指纹识别

### 数据保护和隐私

#### `POST /api/signature/privacy/data-export`
**功能**：为合规目的导出用户数据
**认证**：必需（Clerk JWT）
**导出范围**：
- 用户签字任务
- 关联文件和文档
- 收件人信息
- 审计日志和活动历史
- 系统元数据

**导出功能**：
- 多格式支持（JSON、CSV、PDF）
- 选择性数据包含
- 匿名化选项
- 安全下载链接
- 符合数据保护法规

#### `DELETE /api/signature/privacy/data-deletion`
**功能**：永久删除用户数据
**认证**：必需（Clerk JWT）
**删除范围**：
- 用户签字任务
- 存储中的关联文件
- 收件人信息
- 审计日志（法律允许的情况下）
- 系统引用

**删除功能**：
- 安全数据擦除
- 级联删除处理
- 合规验证
- 删除确认
- 删除过程审计跟踪

---

## 🚀 性能和优化

### 缓存和性能

#### `GET /api/signature/cache/[resource]`
**功能**：获取缓存数据以优化性能
**认证**：必需（Clerk JWT）
**缓存资源**：
- 频繁访问的任务数据
- PDF缩略图生成
- 用户偏好设置
- 系统配置数据
- 搜索索引数据

**缓存功能**：
- 智能缓存失效
- 缓存预热策略
- 性能监控
- 缓存命中/未命中分析
- 分布式缓存支持

### 后台处理

#### `POST /api/signature/background/process`
**功能**：排队后台处理任务
**认证**：必需（Clerk JWT）
**处理任务**：
- PDF生成和优化
- 邮件队列处理
- 文件清理操作
- 分析数据聚合
- 系统维护任务

**队列管理**：
- 基于优先级的处理
- 失败任务重试逻辑
- 进度追踪
- 资源管理
- 错误处理和恢复

---

## 📱 移动端和响应式API

### 移动端优化端点

#### `GET /api/signature/mobile/tasks`
**功能**：获取移动端优化的任务列表
**认证**：必需（Clerk JWT）
**移动端功能**：
- 减少数据负载
- 仅必要信息
- 优化图片尺寸
- 简化响应结构
- 离线功能支持

#### `GET /api/signature/mobile/sign/[token]`
**功能**：移动端优化的签字界面
**认证**：基于Token
**移动端功能**：
- 触控优化坐标系统
- 响应式设计数据
- 简化交互模型
- 离线签字能力
- 移动端特定验证

### 渐进式Web应用支持

#### `GET /api/signature/pwa/manifest`
**功能**：为移动端安装生成PWA清单
**认证**：不需要
**清单功能**：
- 应用图标和元数据
- 离线功能
- 推送通知支持
- 主题定制
- 安装提示

#### `GET /api/signature/pwa/offline-data`
**功能**：获取离线功能的必要数据
**认证**：必需（Clerk JWT）
**离线数据**：
- 缓存任务信息
- 离线功能
- 同步标记
- 冲突解决数据
- 必要系统设置

---

## 🎯 集成和扩展性

### 第三方集成支持

#### `POST /api/signature/integrations/webhook`
**功能**：接收第三方服务的webhooks
**认证**：Webhook签名验证
**集成类型**：
- 文档管理系统
- CRM平台
- 邮件服务提供商
- 云存储服务
- 认证提供商

#### `GET /api/signature/integrations/capabilities`
**功能**：获取可用集成功能
**认证**：必需（Clerk JWT）
**功能信息**：
- 可用集成
- 配置要求
- 功能映射
- 兼容性矩阵
- 集成状态

### API扩展点

#### `POST /api/signature/extensions/custom-action`
**功能**：执行自定义业务逻辑扩展
**认证**：必需（Clerk JWT）
**扩展类型**：
- 自定义验证规则
- 额外通知渠道
- 自定义签字格式
- 业务流程自动化
- 特定合规功能

#### `GET /api/signature/extensions/schema`
**功能**：获取用于自定义开发的API schema
**认证**：必需（Clerk JWT）
**Schema信息**：
- OpenAPI规范
- 数据模型定义
- 事件schemas
- 扩展点
- 开发指南

---

## 📊 分析和报告API

### 使用分析

#### `GET /api/signature/analytics/usage`
**功能**：获取使用分析和统计
**认证**：必需（Clerk JWT）
**分析数据**：
- 任务创建和完成率
- 收件人参与度指标
- 文件处理统计
- 邮件投递性能
- 系统利用模式

#### `GET /api/signature/analytics/performance`
**功能**：系统性能分析
**认证**：必需（Clerk JWT）
**性能指标**：
- API响应时间
- PDF处理持续时间
- 邮件投递速度
- 数据库查询性能
- 存储利用率

### 自定义报告

#### `POST /api/signature/reports/generate`
**功能**：生成自定义报告
**认证**：必需（Clerk JWT）
**报告类型**：
- 任务完成报告
- 收件人活动报告
- 文件处理报告
- 基于时间的分析
- 合规报告

#### `GET /api/signature/reports/[reportId]`
**功能**：获取生成的报告
**认证**：必需（Clerk JWT）
**报告功能**：
- 多导出格式
- 定时报告生成
- 自定义过滤选项
- 可视化数据
- 共享功能

---

## 🔧 错误处理和监控

### 错误管理

#### `GET /api/signature/errors/[errorId]`
**功能**：获取详细错误信息
**认证**：必需（Clerk JWT）
**错误详情**：
- 错误上下文和堆栈跟踪
- 触发错误的用户操作
- 错误时的系统状态
- 建议解决步骤
- 相关错误模式

#### `POST /api/signature/errors/report`
**功能**：报告客户端错误
**认证**：必需（Clerk JWT）
**错误报告**：
- 客户端错误捕获
- 用户体验影响
- 浏览器和设备信息
- 重现步骤
- 用户反馈

### 系统监控

#### `GET /api/signature/monitoring/alerts`
**功能**：获取系统警报和通知
**认证**：必需（管理员JWT）
**警报类型**：
- 系统性能警报
- 安全事件通知
- 服务可用性警报
- 资源利用警告
- 用户活动异常

#### `POST /api/signature/monitoring/custom-metric`
**功能**：提交自定义监控指标
**认证**：必需（Clerk JWT）
**指标类型**：
- 用户交互指标
- 业务流程指标
- 性能测量
- 错误频率追踪
- 功能使用统计

---

## 🎨 API设计模式和标准

### 响应格式标准
- **一致的JSON结构**：所有响应遵循标准化格式
- **错误代码映射**：HTTP状态码映射到特定错误条件
- **分页标准**：为性能使用基于游标的分页
- **时间戳格式**：ISO 8601格式带时区信息
- **本地化支持**：多语言错误消息和响应

### 请求处理标准
- **输入验证**：所有输入的全面验证
- **频率限制**：每个端点可配置的频率限制
- **请求日志**：详细的调试和监控日志
- **响应缓存**：智能缓存策略以提高性能
- **内容协商**：支持多种响应格式

### 安全标准
- **认证**：基于JWT的认证和刷新token
- **授权**：基于角色的访问控制
- **数据加密**：敏感数据的端到端加密
- **输入净化**：防止注入攻击
- **CORS配置**：适当的跨域资源共享设置

---

这个全面的API架构为电子签字系统提供了坚实的基础，确保了可扩展性、安全性和可维护性，同时为任务创建者和收件人提供了卓越的用户体验。
