# 电子签字系统开发大纲

## 📋 最新需求确认 (2024-01-15)

### 🔄 交流总结
经过与用户的深入讨论，确认了以下关键设计决策：

#### 1. 权限控制方案
- **采用公开页面+Token方案**：`/sign?token=xxx`
- **禁用RLS**：签字相关表不使用Row Level Security，采用应用层权限控制
- **不影响登录**：Clerk用户登录完全独立于RLS，系统正常运行
- **安全性简化**：依靠邮箱隐私性和Token过期时间控制风险

#### 2. 核心数据流动
1. **任务创建**：用户登录→创建任务→上传PDF→添加收件人→设置签字位置
2. **邮件发送**：生成收件人唯一token→发送包含token的邮件链接
3. **收件人签字**：点击链接→token验证→显示个性化签字界面→一键签字
4. **状态更新**：记录签字时间→更新状态→检查任务完成

#### 3. 具体签字界面需求
- **个性化显示**：每个收件人只看到自己的签字位置
- **预设显示**：签字位置显示收件人姓名+"点我签字"
- **一键签字**：点击后自动生成"姓名+日期+时间"
- **自动识别**：通过token自动识别收件人身份
- **即时完成**：无需手动输入，点击即完成签字

### 🎯 关键设计原则
- **极简操作**：收件人只需点击邮件链接→点击签字按钮→完成
- **自动化处理**：系统自动识别身份、生成签字内容、记录时间
- **技术简化**：优先选择简单可行的技术方案，不追求复杂的安全机制

### ✍️ 签字样式设计（固定风格电子签字）
**设计目标**：打造固定风格的电子签字样式，让收件人点击后系统自动生成"看起来像签名的艺术字体"，并可附带电子签章小图标，保持简洁且兼顾专业感，适合"轻量签字 + 商业实用"定位。

#### 目标签字样式效果
```
标准格式：
【John Smith】signed at【2025-07-14 14:53:25】

艺术字体效果：
🖋️ 𝑱𝒐𝒉𝒏 𝑺𝒎𝒊𝒕𝒉
✔️ Digital Signature · 2025-07-14
```

#### 实现方案
1. **数据库层面**：无需新增字段，保留`signature_content`字段存储生成的签字内容
2. **后端处理**：签字确认时自动生成固定格式的签字文本
3. **前端展示**：使用艺术字体（Google Fonts或font-cursive）+ Emoji图标增强视觉效果
4. **PDF渲染**：使用固定字体渲染 + 可选电子签章图片插入

#### 技术实现细节
- **前端字体**：使用`font-[cursive]`或Google Fonts渲染艺术字体效果
- **图标选择**：🖋️ 钢笔、🖊️ 笔、✔️ 勾选、📩 邮件等Emoji图标
- **PDF插入**：使用`pdf-lib`在签字位置插入文本 + 可选PNG电子签章图片
- **统一格式**：后端触发器自动生成标准格式，确保所有签字样式一致

#### 用户体验流程
1. **收件人点击**：点击"Click to sign"按钮
2. **系统生成**：自动生成包含姓名、时间、图标的签字内容
3. **样式渲染**：前端使用艺术字体显示，PDF使用固定字体渲染
4. **专业呈现**：最终PDF中显示统一、专业的电子签字样式

## 📋 项目概述

### 系统名称
Digital Signature Management System (DSMS)

### 核心功能
- 用户创建签字任务并上传PDF文件
- 为多个收件人设置签字位置
- 发送签字邀请邮件
- 收件人在线签字
- 任务状态追踪和文件管理

### 技术栈
- **前端**: Next.js 14 + TypeScript + Tailwind CSS
- **后端**: Next.js API Routes
- **数据库**: Supabase (PostgreSQL)
- **文件存储**: Supabase Storage
- **认证**: Clerk
- **邮件服务**: Resend
- **PDF处理**: react-pdf, pdf-lib
- **拖拽功能**: react-draggable

---

## 🗄️ 数据库设计

### 核心表结构（4个主要表）

### 1. 签字任务表 (signature_tasks)


### 2. 签字文件表 (signature_files)


### 3. 签字收件人表 (signature_recipients)
`

### 4. 签字位置表 (signature_positions)


### 5. 索引优化


### 6. 权限控制策略
`
---

## 🔧 API 设计

### 认证相关
- `GET /api/auth/user` - 获取当前用户信息

### 任务管理
- `GET /api/signature/tasks` - 获取用户所有任务
- `POST /api/signature/tasks` - 创建新任务
- `GET /api/signature/tasks/[id]` - 获取任务详情
- `PUT /api/signature/tasks/[id]` - 更新任务
- `DELETE /api/signature/tasks/[id]` - 删除任务
- `POST /api/signature/tasks/[id]/send` - 发送签字邀请

### 文件管理
- `POST /api/signature/files/upload` - 上传PDF文件
- `GET /api/signature/files/[id]` - 获取文件信息
- `GET /api/signature/files/[id]/download` - 下载文件
- `DELETE /api/signature/files/[id]` - 删除文件

### 收件人管理
- `GET /api/signature/tasks/[id]/recipients` - 获取任务收件人列表
- `POST /api/signature/tasks/[id]/recipients` - 添加收件人
- `PUT /api/signature/recipients/[id]` - 更新收件人信息
- `DELETE /api/signature/recipients/[id]` - 删除收件人

### 签字位置管理
- `GET /api/signature/recipients/[id]/positions` - 获取收件人签字位置
- `POST /api/signature/recipients/[id]/positions` - 设置签字位置
- `PUT /api/signature/positions/[id]` - 更新签字位置
- `DELETE /api/signature/positions/[id]` - 删除签字位置

### 签字流程 (公开API)
- `GET /api/sign/verify?token=xxx` - 验证token并获取签字信息
  ```json
  {
    "valid": true,
    "recipient": {
      "name": "张三",
      "email": "zhang@example.com"
    },
    "task": {
      "title": "合同签署",
      "description": "请签署以下合同"
    },
    "files": [
      {
        "id": "file-1",
        "filename": "contract.pdf",
        "signed_url": "https://...",
        "positions": [
          {
            "id": "pos-1",
            "page": 1,
            "x": 50,
            "y": 80,
            "width": 20,
            "height": 5,
            "placeholder": "张三 - 点我签字"
          }
        ]
      }
    ]
  }
  ```

- `POST /api/sign/execute` - 执行一键签字
  ```json
  {
    "token": "recipient_token",
    "position_id": "pos-1",
    "action": "sign"
  }
  ```
  响应：
  ```json
  {
    "success": true,
    "signature_content": "张三 2024-01-15 14:35:42",
    "position_id": "pos-1",
    "signed_at": "2024-01-15T14:35:42Z"
  }
  ```

- `GET /api/sign/status?token=xxx` - 获取签字状态
  ```json
  {
    "recipient_status": "signed",
    "completed_positions": 3,
    "total_positions": 3,
    "all_files_signed": true
  }
  ```

### 邮件服务
- `POST /api/signature/email/invite` - 发送邀请邮件
- `POST /api/signature/email/confirmation` - 发送确认邮件

### 文件处理
- `POST /api/signature/pdf/generate-final` - 生成最终签字文件
- `GET /api/signature/pdf/preview/[fileId]` - 预览PDF文件

---

## 🎨 前端页面设计

### 1. 任务列表页面 `/app/signature`
**功能**: 显示用户所有签字任务
**组件结构**:
```
SignatureTasksPage
├── PageHeader (标题 + 新建按钮)
├── TaskFilters (状态筛选)
├── TaskList
│   └── TaskCard (任务卡片 + 签字进度)
└── EmptyState (无任务时显示)
```

### 2. 创建/编辑任务页面 `/app/signature/create` 和 `/app/signature/[id]/edit`
**功能**: 创建或编辑签字任务
**组件结构**:
```
CreateTaskPage
├── TaskBasicInfo (标题、描述)
├── MultiPDFUploader (支持多文件上传)
├── RecipientManager (收件人管理)
│   ├── RecipientList (收件人列表)
│   └── AddRecipientForm (添加收件人)
├── SignaturePositionEditor (签字位置设置)
│   ├── PDFPreview (PDF预览)
│   ├── PositionDragArea (拖拽设置签字位置)
│   └── PositionList (位置列表管理)
└── TaskActions (保存草稿、发送邀请)
```

### 3. 任务详情页面 `/app/signature/[id]`
**功能**: 查看任务详情和签字状态
**组件结构**:
```
TaskDetailPage
├── TaskHeader (任务信息)
├── TaskStatus (状态指示器)
├── FilesList (文件列表)
├── RecipientStatusList (收件人签字状态)
│   ├── RecipientCard (收件人状态卡片)
│   └── ProgressIndicator (签字进度)
├── FileDownloads (文件下载)
└── TaskActions (重发邀请、撤销、删除)
```

### 4. 签字页面 `/sign?token=xxx` (公开页面)
**功能**: 收件人一键签字页面
**核心特性**:
- **个性化显示**: 只显示当前收件人的签字位置
- **一键签字**: 点击即完成签字操作
- **自动生成**: 自动生成签字内容(姓名+时间)

**组件结构**:
```
SignaturePage
├── WelcomeHeader (欢迎信息)
│   ├── RecipientInfo (收件人姓名)
│   └── TaskInfo (任务标题、描述)
├── SignatureInstructions (签字说明)
├── PDFSignatureViewer (PDF签字查看器)
│   ├── PDFRenderer (PDF渲染)
│   ├── PersonalizedSignatureBoxes (个性化签字框)
│   │   ├── SignatureBox (签字框组件)
│   │   │   ├── RecipientLabel (收件人姓名)
│   │   │   ├── SignButton ("点我签字"按钮)
│   │   │   └── SignedIndicator (已签字标识)
│   │   └── OtherRecipientPlaceholder (其他收件人位置占位)
│   └── NavigationControls (页面导航)
├── SignatureProgress (签字进度)
└── CompletionSummary (完成摘要)
```

**签字交互流程**:
1. **页面加载**: 验证token → 获取个性化数据 → 渲染PDF
2. **显示签字框**: 只显示当前收件人的签字位置，显示"[姓名] - Click to sign"
3. **一键签字**: 点击按钮 → 自动生成艺术字体签字内容 → 更新PDF → 显示完成状态
4. **状态更新**: 实时更新签字状态 → 检查是否全部完成

**签字样式特性**:
- **固定格式**: 系统自动生成统一的签字内容格式
- **艺术字体**: 前端使用cursive字体渲染，增强视觉效果
- **图标装饰**: 使用🖋️、✔️等Emoji图标增加专业感
- **PDF渲染**: 最终PDF中显示清晰的固定字体签字效果

### 5. 签字位置编辑器组件 (核心组件)
**功能**: 为收件人设置签字位置
**组件结构**:
```
SignaturePositionEditor
├── PDFCanvas (PDF画布)
├── RecipientSelector (收件人选择器)
├── DraggableSignatureBox (可拖拽签字框)
│   ├── ResizableHandle (调整大小手柄)
│   ├── PositionLabel (位置标签)
│   └── PreviewText (预览文本)
├── PositionToolbar (位置工具栏)
│   ├── DeleteButton (删除位置)
│   ├── CopyButton (复制位置)
│   └── SettingsButton (位置设置)
└── PositionList (位置列表)
```

### 6. 组件设计原则
- **响应式设计**: 支持桌面端和移动端
- **实时更新**: 状态变化实时反映
- **用户友好**: 操作简单直观
- **错误处理**: 完善的错误提示和处理
- **加载状态**: 清晰的加载指示器

---

## 🚀 开发阶段划分

## 阶段一：基础架构搭建 (Week 1)

### 步骤 1.1: 项目初始化
- [ ] 创建签字模块目录结构
- [ ] 配置必要的依赖包 (react-pdf, pdf-lib, react-draggable, resend)
- [ ] 设置环境变量和配置文件

### 步骤 1.2: 数据库设计 (重点：4表结构)
- [ ] 创建signature_tasks表
- [ ] 创建signature_files表 (支持多文件)
- [ ] 创建signature_recipients表 (包含token字段)
- [ ] 创建signature_positions表
- [ ] 设置索引和约束
- [ ] **禁用RLS，采用应用层权限控制**

### 步骤 1.3: 基础API框架
- [ ] 创建API路由结构
- [ ] 设置错误处理中间件
- [ ] 配置Clerk认证验证
- [ ] **实现Token验证中间件**

## 阶段二：核心功能开发 (Week 2-3)

### 步骤 2.1: 任务管理系统
- [ ] 实现任务CRUD操作
- [ ] 创建任务列表页面
- [ ] 实现任务状态管理
- [ ] **支持多文件任务创建**

### 步骤 2.2: 多文件上传功能
- [ ] 实现PDF多文件上传
- [ ] 配置Supabase存储
- [ ] 添加文件格式和大小验证
- [ ] **文件顺序管理**

### 步骤 2.3: 收件人管理 (重点：Token生成)
- [ ] 实现收件人增删改查
- [ ] **生成唯一token系统**
- [ ] **设置token过期时间**
- [ ] 创建收件人管理界面

## 阶段三：签字位置设置 (Week 4)

### 步骤 3.1: PDF预览功能
- [ ] 集成react-pdf
- [ ] 实现多文件PDF页面渲染
- [ ] 添加缩放和导航功能
- [ ] **文件切换功能**

### 步骤 3.2: 拖拽签字框
- [ ] 集成react-draggable
- [ ] 实现签字框拖拽功能
- [ ] 保存签字位置坐标
- [ ] **支持多收件人位置设置**

### 步骤 3.3: 签字位置管理
- [ ] 实现位置数据存储
- [ ] 添加位置编辑功能
- [ ] **实现多收件人、多文件位置管理**
- [ ] **位置预览和验证**

## 阶段四：公开页面签字流程 (Week 5) - 重点阶段

### 步骤 4.1: 公开签字页面开发
- [ ] **创建/sign?token=xxx公开页面**
- [ ] **实现token验证逻辑**
- [ ] **个性化显示收件人签字位置**
- [ ] **隐藏其他收件人位置**

### 步骤 4.2: 一键签字功能 (核心功能)
- [ ] **实现"Click to sign"按钮**
- [ ] **自动生成固定格式签字内容(姓名+时间)**
- [ ] **前端艺术字体渲染(font-cursive + Emoji图标)**
- [ ] **集成pdf-lib处理签字插入**
- [ ] **实时状态更新**
- [ ] **统一签字样式设计实现**

### 步骤 4.3: 邮件发送系统
- [ ] 配置Resend邮件服务
- [ ] 创建邮件模板
- [ ] **实现包含token的邀请邮件**
- [ ] **发送完成确认邮件**

## 阶段五：状态追踪和优化 (Week 6)

### 步骤 5.1: 状态管理优化
- [ ] 实现任务状态自动更新
- [ ] **签字进度实时显示**
- [ ] **收件人状态追踪**
- [ ] 优化状态转换逻辑

### 步骤 5.2: 文件合成功能
- [ ] 实现最终PDF合成
- [ ] **多文件签字合并**
- [ ] 添加文件版本管理
- [ ] 优化文件存储

### 步骤 5.3: 用户体验优化
- [ ] **移动端签字页面优化**
- [ ] 添加加载状态和错误处理
- [ ] **签字完成动画和反馈**
- [ ] 优化响应式设计

## 阶段六：测试和部署 (Week 7)

### 步骤 6.1: 功能测试
- [ ] **公开页面Token验证测试**
- [ ] **一键签字功能测试**
- [ ] **多收件人并发签字测试**
- [ ] 端到端测试

### 步骤 6.2: 性能优化
- [ ] 文件上传和处理优化
- [ ] 数据库查询优化
- [ ] **PDF渲染性能优化**
- [ ] 前端性能优化

### 步骤 6.3: 部署准备
- [ ] 生产环境配置
- [ ] **Token安全性检查**
- [ ] 监控和日志配置
- [ ] 用户手册编写

---

## 📝 重点开发任务 (基于交流总结)

### 🔴 最高优先级 (立即开始)
1. **Token验证系统** - 公开页面访问的核心
2. **4表数据库结构** - 支持多文件多收件人
3. **禁用RLS配置** - 简化权限控制
4. **一键签字API** - 自动生成签字内容

### 🟡 高优先级 (Week 2-3)
1. **多文件上传管理** - 支持任务包含多个PDF
2. **个性化签字页面** - 只显示当前收件人位置
3. **签字位置拖拽设置** - 为每个收件人设置位置
4. **邮件Token链接** - 包含token的邀请邮件

### 🟢 中优先级 (Week 4-5)
1. **状态追踪系统** - 实时更新签字进度
2. **文件合成功能** - 生成最终签字文件
3. **移动端优化** - 移动设备签字体验
4. **错误处理** - 完善的异常处理机制

### 📊 开发成功指标
- [ ] 收件人点击邮件链接可直接访问签字页面
- [ ] 页面只显示当前收件人的签字位置
- [ ] 点击"Click to sign"自动完成签字
- [ ] 自动生成固定格式"姓名+时间"签字内容
- [ ] 前端显示艺术字体签字效果
- [ ] PDF中生成统一专业的签字样式
- [ ] 支持多文件多收件人签字任务
- [ ] 任务状态实时更新和追踪

---

## 🚨 潜在遗漏点和风险 (基于交流总结更新)

### 1. 公开页面+Token方案的安全性考虑
- [ ] **Token泄露风险**: 邮件转发或链接分享可能导致未授权访问
- [ ] **Token过期机制**: 需要合理设置过期时间平衡安全性和用户体验
- [ ] **一次性使用限制**: 考虑token是否可重复使用
- [ ] **IP地址记录**: 记录签字时的IP地址用于审计
- [ ] **访问日志**: 完整记录token的访问历史
- [ ] **移动端链接处理**: 确保移动设备上的邮件链接正常工作

### 2. 一键签字功能的技术风险
- [ ] **PDF处理性能**: 大文件或多文件签字时的性能问题
- [ ] **并发签字**: 多人同时签字时的数据一致性和锁定机制
- [ ] **签字内容格式**: 自动生成的签字内容格式标准化
- [ ] **时区处理**: 不同地区收件人的时间显示问题
- [ ] **签字位置精度**: 在不同设备上的签字位置准确性
- [ ] **PDF兼容性**: 不同PDF格式的兼容性问题

### 3. 多文件多收件人复杂度
- [ ] **状态同步**: 多文件签字进度的实时同步
- [ ] **部分签字**: 部分收件人签字部分文件的状态管理
- [ ] **文件顺序**: 多文件签字时的顺序控制
- [ ] **存储空间**: 大量文件和最终合成文件的存储成本
- [ ] **文件合并**: 多文件签字完成后的合并逻辑
- [ ] **版本控制**: 文件修改和版本管理问题

### 4. 用户体验遗漏点
- [ ] **移动端适配**: 签字页面在不同移动设备上的适配
- [ ] **网络中断**: 签字过程中网络中断的处理
- [ ] **浏览器兼容**: 不同浏览器的PDF显示和签字功能
- [ ] **加载性能**: 大文件PDF的加载和渲染性能
- [ ] **错误恢复**: 签字失败时的重试机制
- [ ] **进度提示**: 签字过程的清晰进度指示

### 5. 业务逻辑遗漏 (基于简化需求)
- [ ] **签字撤销**: 已签字但任务未完成时的撤销机制
- [ ] **邮件退回**: 邮件发送失败的处理
- [ ] **收件人邮箱变更**: 收件人邮箱地址变更的处理
- [ ] **任务过期**: 长时间未完成任务的处理
- [ ] **重发机制**: 收件人未收到邮件时的重发功能
- [ ] **签字验证**: 签字内容的合法性验证

### 6. 数据库性能和扩展性
- [ ] **查询优化**: 多表关联查询的性能优化
- [ ] **数据清理**: 过期token和无效数据的清理
- [ ] **备份策略**: 重要签字数据的备份和恢复
- [ ] **并发控制**: 高并发场景下的数据库性能
- [ ] **索引策略**: 随着数据量增长的索引优化
- [ ] **分页查询**: 大量任务和收件人的分页处理

### 7. 禁用RLS的安全影响
- [ ] **应用层权限**: 确保所有API都有完善的权限检查
- [ ] **SQL注入**: 防止参数化查询遗漏导致的安全问题
- [ ] **数据泄露**: 应用层权限失效时的数据保护
- [ ] **审计日志**: 所有数据访问的审计记录
- [ ] **开发规范**: 开发团队的安全编码规范
- [ ] **代码审查**: 权限相关代码的严格审查

### 8. 邮件系统依赖风险
- [ ] **邮件服务限制**: Resend服务的发送限制和成本
- [ ] **邮件到达率**: 邮件被标记为垃圾邮件的风险
- [ ] **邮件模板**: 邮件内容的多语言和个性化
- [ ] **邮件追踪**: 邮件发送和打开状态的追踪
- [ ] **服务中断**: 邮件服务中断时的备用方案
- [ ] **合规要求**: 邮件发送的法律合规要求

### 9. 移动端特殊考虑
- [ ] **触摸操作**: 移动设备上的签字位置精确点击
- [ ] **屏幕尺寸**: 不同屏幕尺寸的PDF显示适配
- [ ] **网络环境**: 移动网络下的文件加载优化
- [ ] **应用唤起**: 邮件客户端到浏览器的跳转
- [ ] **横竖屏**: 设备旋转时的界面适配
- [ ] **操作系统**: iOS/Android不同系统的兼容性

### 10. 法律和合规风险
- [ ] **电子签名法律效力**: 不同地区的电子签名法律要求
- [ ] **数据保护**: GDPR等数据保护法规的合规
- [ ] **审计要求**: 签字过程的完整审计记录
- [ ] **身份验证**: 某些场景下的身份验证要求
- [ ] **数据存储**: 签字数据的保存期限和位置要求
- [ ] **争议处理**: 签字争议时的证据保全

---

## 🔧 风险缓解策略

### 技术风险缓解
1. **渐进式开发**: 先实现基础功能，逐步添加复杂特性
2. **性能测试**: 每个阶段都进行充分的性能测试
3. **容错设计**: 关键功能都有错误处理和恢复机制
4. **监控告警**: 实时监控系统状态和性能指标

### 安全风险缓解
1. **多层验证**: Token验证+时间验证+状态验证
2. **访问记录**: 完整的访问和操作日志
3. **定期审计**: 定期检查权限控制和安全配置
4. **安全测试**: 渗透测试和安全漏洞扫描

### 用户体验风险缓解
1. **多设备测试**: 在各种设备和浏览器上测试
2. **用户反馈**: 收集用户使用反馈并快速迭代
3. **错误处理**: 友好的错误提示和处理流程
4. **性能优化**: 持续优化加载速度和响应时间

---

## 🎯 开发优先级建议

### 🔴 高优先级 (MVP功能)
1. 用户认证和任务管理
2. PDF文件上传和存储
3. 收件人管理和token生成
4. 基础签字页面
5. 邮件发送功能

### 🟡 中优先级 (核心功能)
1. 签字位置拖拽设置
2. 任务状态追踪
3. 文件合成功能
4. 用户体验优化

### 🟢 低优先级 (增强功能)
1. 高级签字功能
2. 模板管理
3. 数据导出
4. 批量操作

---

## 📚 技术文档结构

### 1. API文档
- 所有API端点的详细说明
- 请求/响应格式
- 错误代码说明

### 2. 数据库文档
- 表结构说明
- 字段定义
- 关系图

### 3. 部署文档
- 环境配置说明
- 部署步骤
- 监控设置

### 4. 用户手册
- 功能使用说明
- 常见问题解答
- 故障排除指南

---

## 🏁 交付标准

### 代码质量
- [ ] TypeScript类型覆盖率 > 90%
- [ ] 单元测试覆盖率 > 80%
- [ ] ESLint检查无错误
- [ ] 代码注释完整

### 性能要求
- [ ] 页面加载时间 < 3秒
- [ ] 文件上传处理时间 < 30秒
- [ ] 签字处理时间 < 10秒
- [ ] 邮件发送时间 < 5秒

### 安全要求
- [ ] 所有API端点都有认证
- [ ] 敏感数据加密存储
- [ ] 文件访问权限控制
- [ ] XSS和CSRF防护

---

## 🔄 迭代计划

### 版本 1.0 (MVP)
- 基础签字功能
- 简单的任务管理
- 邮件发送

### 版本 1.1
- 签字位置拖拽
- 状态追踪优化
- 移动端适配

### 版本 1.2
- 高级功能
- 模板管理
- 性能优化

### 版本 2.0
- 企业级功能
- 集成第三方服务
- 高级报表

---

## 📋 开发大纲总结 (基于2024-01-15交流确认)

### 🎯 核心设计决策
1. **公开页面+Token方案**: 采用`/sign?token=xxx`的公开访问方式
2. **禁用RLS**: 使用应用层权限控制，简化技术复杂度
3. **一键签字**: 收件人点击即完成签字，自动生成"姓名+时间"
4. **多文件多收件人**: 支持单任务包含多个PDF和多个收件人
5. **个性化显示**: 每个收件人只看到自己的签字位置

### 🗄️ 数据库架构
- **4个核心表**: tasks, files, recipients, positions
- **禁用RLS**: 采用应用层权限验证
- **Token机制**: 每个收件人唯一token，设置过期时间
- **状态管理**: 完整的任务和收件人状态流转

### 🔧 技术实现要点
- **Token验证**: 公开页面通过token验证收件人身份
- **个性化渲染**: 根据token只显示对应收件人的签字位置
- **自动签字**: 点击按钮自动生成签字内容并插入PDF
- **签字样式**: 前端艺术字体渲染 + PDF固定字体插入
- **图标装饰**: 使用Emoji图标增强签字视觉效果
- **统一格式**: 后端触发器确保所有签字样式一致
- **实时更新**: 签字后即时更新状态和进度
- **邮件集成**: 发送包含token的邮件链接

### 🎨 用户体验设计
- **极简操作**: 收件人只需点击邮件→点击签字→完成
- **移动优化**: 特别优化移动端签字体验
- **状态反馈**: 清晰的签字进度和完成状态提示
- **错误处理**: 友好的错误提示和恢复机制

### 🚀 开发优先级
1. **最高优先级**: Token验证系统、4表数据库、禁用RLS
2. **高优先级**: 一键签字功能、个性化显示、邮件发送
3. **中优先级**: 状态追踪、文件合成、移动端优化

### 🔒 安全考虑
- **邮箱隐私**: 依靠邮件隐私性保护token
- **过期控制**: 7天token过期时间
- **访问记录**: 完整的访问和操作日志
- **应用层验证**: 严格的API权限检查

### 📊 成功指标
- [x] 收件人点击邮件可直接访问签字页面
- [x] 页面个性化显示收件人签字位置
- [x] 一键完成签字操作
- [x] 自动生成签字内容(姓名+时间)
- [x] 支持多文件多收件人任务
- [x] 实时状态更新和进度追踪

### 🎯 项目里程碑
- **Week 1**: 基础架构和数据库设计
- **Week 2-3**: 核心功能和多文件管理
- **Week 4**: 签字位置设置和PDF预览
- **Week 5**: 公开页面和一键签字(核心阶段)
- **Week 6**: 状态追踪和用户体验优化
- **Week 7**: 测试部署和性能优化

### 💡 设计优势
- **技术简化**: 避免复杂的RLS和混合权限控制
- **用户友好**: 最简单的签字流程
- **开发高效**: 清晰的技术方案和实现路径
- **可扩展**: 预留未来功能扩展空间

这个开发大纲完全基于我们的深度交流确认，确保了技术方案的可行性和用户需求的满足。 